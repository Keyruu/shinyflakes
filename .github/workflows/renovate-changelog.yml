name: Fetch Changelog for Renovate PRs
#
# This workflow automatically fetches and analyzes changelogs for Renovate PRs.
#
# Automatic triggers:
# - When Renovate creates or updates a PR (skips if "Release Notes" already present)
#
# Manual trigger:
# - Comment "/changelog" on any PR to manually fetch and analyze the changelog
#   (bypasses the "Release Notes" check)
#
# Required secrets:
# - CUSTOM_AI_API_KEY: Your AI provider's API key
# - CUSTOM_AI_ENDPOINT: (Optional) Your AI provider's endpoint URL

on:
  pull_request:
    types: [opened, synchronize]
  issue_comment:
    types: [created]

jobs:
  fetch_changelog:
    if: |
      (github.event_name == 'pull_request' && (github.actor == 'renovate[bot]' || github.actor == 'renovate')) ||
      (github.event_name == 'issue_comment' && github.event.issue.pull_request && contains(github.event.comment.body, '/changelog'))
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: read
      issues: write
    outputs:
      changelog_summary: ${{ steps.run_codex.outputs.final-message }}
      pr_number: ${{ steps.get_pr.outputs.number }}
    steps:
      - name: Get PR details
        id: get_pr
        uses: actions/github-script@v8
        with:
          script: |
            let prNumber, prBody;

            if (context.eventName === 'pull_request') {
              prNumber = context.payload.pull_request.number;
              prBody = context.payload.pull_request.body;
            } else if (context.eventName === 'issue_comment') {
              prNumber = context.payload.issue.number;
              const { data: pr } = await github.rest.pulls.get({
                owner: context.repo.owner,
                repo: context.repo.repo,
                pull_number: prNumber
              });
              prBody = pr.body;
            }

            core.setOutput('number', prNumber);
            core.setOutput('body', prBody);
            return { number: prNumber, body: prBody };

      - name: Check if changelog already exists
        id: check_changelog
        env:
          PR_BODY: ${{ steps.get_pr.outputs.body }}
        run: |
          if [ "${{ github.event_name }}" = "issue_comment" ]; then
            echo "has_changelog=false" >> $GITHUB_OUTPUT
            echo "Manually triggered, running AI analysis"
          elif echo "$PR_BODY" | grep -q "Release Notes"; then
            echo "has_changelog=true" >> $GITHUB_OUTPUT
            echo "Renovate already included release notes, skipping AI analysis"
          else
            echo "has_changelog=false" >> $GITHUB_OUTPUT
            echo "No release notes found, will fetch changelog via AI"
          fi

      - name: Run Codex to Fetch Changelog
        id: run_codex
        if: steps.check_changelog.outputs.has_changelog == 'false'
        uses: openai/codex-action@v1
        with:
          responses-api-endpoint: ${{ secrets.CUSTOM_AI_ENDPOINT }}
          openai-api-key: ${{ secrets.CUSTOM_AI_API_KEY }}
          model: "gpt-oss-120b" # Uncomment and adjust if your provider supports model selection

          sandbox: read-only
          safety-strategy: drop-sudo

          prompt: |
            You are analyzing a Renovate bot pull request for a container/package update.

            Here is the full PR body from Renovate:
            ---
            ${{ steps.get_pr.outputs.body }}
            ---

            **Your Task:**

            1. Parse the PR body to identify:
               - The package/container being updated
               - Old and new versions
               - Source repository link (if available)

            2. Find and fetch the changelog:
               - Use any source links provided in the PR
               - For GitHub repos, check releases, CHANGELOG.md, or commit history
               - For other sources, look for release documentation

            3. Analyze the changes for:
               - üî¥ BREAKING CHANGES (incompatible API changes, removed features)
               - ‚ö†Ô∏è Important changes (security fixes, deprecations, config changes)
               - ‚ú® Notable new features
               - üêõ Important bug fixes
               - üìù Migration requirements

            4. Format your response as markdown:

            ## üìã Changelog Summary

            **Package:** [name]
            **Version:** [old] ‚Üí [new]

            ### üî¥ Breaking Changes
            [List breaking changes, or "None identified"]

            ### ‚ö†Ô∏è Important Changes
            [Security fixes, deprecations, important updates]

            ### ‚ú® New Features
            [Notable new features]

            ### üêõ Bug Fixes
            [Important bug fixes]

            ### üìù Migration Notes
            [Steps needed to upgrade, or "No special migration required"]

            ### üîó References
            [Links to sources]

            ---

            **Guidelines:**
            - Be concise but thorough
            - Prioritize breaking changes and security fixes
            - If no changelog is available, clearly state that
            - Focus on what matters for upgrading

  post_changelog:
    runs-on: ubuntu-latest
    needs: fetch_changelog
    if: needs.fetch_changelog.outputs.changelog_summary != ''
    permissions:
      issues: write
      pull-requests: write
    steps:
      - name: Post Changelog Comment
        uses: actions/github-script@v8
        env:
          CHANGELOG_SUMMARY: ${{ needs.fetch_changelog.outputs.changelog_summary }}
          PR_NUMBER: ${{ needs.fetch_changelog.outputs.pr_number }}
        with:
          github-token: ${{ github.token }}
          script: |
            const body = `${process.env.CHANGELOG_SUMMARY}\n\n---\n*ü§ñ Generated by AI-powered changelog analysis*`;

            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: process.env.PR_NUMBER,
              body: body,
            });
